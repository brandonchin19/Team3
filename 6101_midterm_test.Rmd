---
title: "DATS 6101 Midterm"
authors: "Brandon Chin, Paul Kelly, Ksenia Shadrina, Luke Wu"
date: "2/16/22"
# date: "`r Sys.Date()`"
output:
  html_document:
    code_folding: hide
    number_sections: false
    toc: yes
    toc_depth: 3
    toc_float: yes
  pdf_document:
    toc: yes
    toc_depth: '3'
---

```{r init, include=FALSE}
# some of common options (and the defaults) are: 
# include=T, eval=T, echo=T, results='hide'/'asis'/'markup',..., collapse=F, warning=T, message=T, error=T, cache=T, fig.width=6, fig.height=4, fig.dim=c(6,4) #inches, fig.align='left'/'center','right', 
library(ezids)
# knitr::opts_chunk$set(warning = F, results = "markup", message = F)
knitr::opts_chunk$set(warning = F, results = "show", message = F)
options(scientific=T, digits = 3) 
# options(scipen=9, digits = 3) 
# ‘scipen’: integer. A penalty to be applied when deciding to print numeric values in fixed or exponential notation.  Positive values bias towards fixed and negative towards scientific notation: fixed notation will be preferred unless it is more than ‘scipen’ digits wider.
# use scipen=999 to prevent scientific notation at all times
```

### Research Topic:

There is considerable evidence indicating lending disparities throughout the United States. (Steil et. al: 2018). For our research topic, we will explore lending practices in one of the fastest appreciating real estate markets over the past thirty years - the state of California. Specifically, we aim to look at the factors that are associated with denials for non-commercial mortgage loans.

Our SMART question is:

“Which factors drove denials for mortgages in California in 2019?”

To answer this question, we are using the Federal Financial Institutions Examination Council's (FFIEC) Home Mortgage Disclosure Act (HMDA) dataset from 2019, located here: https://ffiec.cfpb.gov/data-publication/dynamic-national-loan-level-dataset/2019. We are  focusing on a subset of data of 10,000 observations from 2019 that we will further filter on California leaving us with 5,196 observations.

Our Github repository address is:https://github.com/brandonchin19/Team3/.

### Load in dataset

```{r}
hmda <- data.frame(read.csv("2019_lar.csv"))
str(hmda)
```

# Check number of rows

```{r}
nrow(hmda)
```


# Check head and tail of dataframe

```{r}
xkabledplyhead(hmda,5)
xkabledplytail(hmda,5)
```

# Subsetting to California Only

```{r}
hmda_ca <- subset(hmda,state_code=="CA")
str(hmda_ca)
```

# Subsetting to California Only; non-business properties; principal residences only

```{r}
hmda_ca <- subset(hmda_ca,business_or_commercial_purpose=="2")
str(hmda_ca)
```


```{r}
hmda_ca <- subset(hmda_ca,occupancy_type=="1")
str(hmda_ca)
```

# Subsetting to only relevant columns

```{r}
hmda_ca_final <- hmda_ca[c(10,11,12,13,22,24,39,46,78)]
str(hmda_ca_final)
```


# Changing vector types

```{r}
hmda_ca_final_1 = hmda_ca_final
hmda_ca_final_1$derived_ethnicity = factor(hmda_ca_final$derived_ethnicity)
hmda_ca_final_1$derived_race = factor(hmda_ca_final$derived_race)
hmda_ca_final_1$derived_sex = factor(hmda_ca_final$derived_sex)
hmda_ca_final_1$action_taken = factor(hmda_ca_final$action_taken)
hmda_ca_final_1$loan_amount = as.numeric(hmda_ca_final$loan_amount)
hmda_ca_final_1$interest_rate = as.numeric(hmda_ca_final$interest_rate)
hmda_ca_final_1$property_value = as.numeric(hmda_ca_final$property_value)
hmda_ca_final_1$income = as.numeric(hmda_ca_final$income)
hmda_ca_final_1$applicant_age = factor(hmda_ca_final$applicant_age)
str(hmda_ca_final_1)
```

# Histograms and Box Plots

```{r}
library(ggplot2)
ggplot(hmda_ca_final_1,aes(x=loan_amount))+
  geom_histogram(color="black", fill="purple")+
  labs(title="Histogram of Loan Amount", x="Loan Amount in dollars", y="Frequency")
```

Loan amount distribution does not appear to be normal (mean is greater than the median).

```{r}
library(ggplot2)
ggplot(hmda_ca_final_1,aes(x=interest_rate))+
  geom_histogram(color="black", fill="pink")+
  labs(title="Histogram of Interest Rates", x="Interest Rates", y="Frequency")
```

Interest rate distribution does not appear to be normal (mean is greater than the median).


```{r}
ggplot(hmda_ca,aes(y=income))+
  geom_boxplot(color="black", fill="green")+
  labs(title="Boxplot of Incomes", y="Income in dollars", x="Frequency")
```


```{r}
ggplot(hmda_ca_final_1,aes(y=property_value))+
  geom_boxplot(color="black", fill="red")+
  labs(title="Boxplot of Property Values", y="Property Values in dollars", x="Frequency")
```

```{r}
library(ggplot2)
qplot(data = hmda_ca_final_1,
      x = loan_amount,
      y = derived_race,
      color = action_taken,
      main="Loan amount and Race by Action taken")
```

Loan amounts and loan originations are higher for white borrowers; loan amounts for other races are lower, and loan rejection rates are higher particularly for Black or African American Borrowers. The lower the loan amount, the higher the likelihood of the loan being rejected?

# Exploring columns that appear to have lots of NAs

```{r}
summary(hmda_ca_final_1$interest_rate)
```


```{r}
summary(hmda_ca_final_1$property_value)
```

```{r}
summary(hmda_ca_final_1$income)
```

```{r}
summary(hmda_ca_final_1$loan_amount)
```


```{r}
qqnorm(hmda_ca_final_1$interest_rate,
       main="QQ Plot of Interest Rates",
       ylab="Interest Rate",
       col="pink")
qqline(hmda_ca_final_1$interest_rate)
```


```{r}
qqnorm(hmda_ca_final_1$property_value,
       main="QQ Plot of Property Values",
       ylab="Property Value",
       col="purple")
qqline(hmda_ca_final_1$property_value)
```

```{r}
qqnorm(hmda_ca_final_1$income,
       main="QQ Plot of Income",
       ylab="Income",
       col="green")
qqline(hmda_ca_final_1$income)
```


```{r}
qqnorm(hmda_ca_final_1$loan_amount,
       main="QQ Plot of Loan Amount",
       ylab="Loan Amount",
       col="blue")
qqline(hmda_ca_final_1$loan_amount)
```

# Removing outliers from interest_rate, property value, income, and loan amount

Can we approach more normalized distributions in loan amount and interest rates by removing outliers (1493 for interest rate, and 977 for property value)?

```{r}
hmda_ca_final_no_outliers_1 <- outlierKD2(hmda_ca_final_1,interest_rate)
```


```{r}
hmda_ca_final_no_outliers_2 <- outlierKD2(hmda_ca_final_no_outliers_1,property_value)
```

```{r}
hmda_ca_final_no_outliers_3 <- outlierKD2(hmda_ca_final_no_outliers_2,income)
```

```{r}
loans <- outlierKD2(hmda_ca_final_no_outliers_3,loan_amount)
```

```{r}
qqnorm(loans$interest_rate,
       main="QQ Plot of Interest Rates",
       ylab="Interest Rate",
       col="pink")
qqline(loans$interest_rate)
```
```{r}
qqnorm(loans$property_value,
       main="QQ Plot of Property Values",
       ylab="Property Value",
       col="purple")
qqline(loans$property_value)
```


```{r}
qqnorm(loans$income,
       main="QQ Plot of Income",
       ylab="Income",
       col="green")
qqline(loans$income)
```


```{r}
qqnorm(loans$loan_amount,
       main="QQ Plot of Loan Amount",
       ylab="Loan Amount",
       col="blue")
qqline(loans$loan_amount)
```
Numeric values are now much more normal and better suited for analysis.